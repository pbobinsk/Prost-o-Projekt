name: System E2E Tests (Dockerized)

on:
  workflow_dispatch:
  push:
    branches: [ "main", "phase-*" ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Tworzymy .env (nadal potrzebny dla aplikacji)
      - name: Create .env file
        run: |
          echo "JWT_SECRET=ci-secret-key-123" > .env
          # WAÅ»NE: WewnÄ…trz sieci Dockera frontend to 'http://frontend', a nie localhost!
          echo "BASE_URL=http://frontend" >> .env 

      # 2. Uruchamiamy system (AplikacjÄ™)
      # UÅ¼ywamy flagi '-p', aby nazwa sieci byÅ‚a staÅ‚a: 'prost-o-projekt_default'
      - name: Start System
        run: docker compose -p prost-o-projekt up -d --build

      # 3. Czekamy na gotowoÅ›Ä‡ (TwÃ³j skrypt healthcheck)
      - name: Wait for Services
        timeout-minutes: 5
        run: |
          # Tutaj sprawdzamy localhost, bo curl dziaÅ‚a z poziomu runnera (zewnÄ…trz kontenerÃ³w)
          # Porty 3000 i 80 sÄ… zmapowane na hosta, wiÄ™c to zadziaÅ‚a.
          echo "Czekam na API Gateway..."
          until curl -s -f -o /dev/null "http://localhost:3000"; do
            sleep 5
          done
          echo "âœ… API Gateway dziaÅ‚a!"

          echo "Czekam na Frontend..."
          until curl -s -f -o /dev/null "http://localhost:80"; do
            sleep 5
          done
          echo "âœ… Frontend dziaÅ‚a!"

      - name: ðŸš¨ DEBUG - Check Container Status
        if: failure() || cancelled() # Uruchom, jeÅ›li Wait zawiedzie
        run: docker compose -p prost-o-projekt ps -a

      - name: ðŸš¨ DEBUG - Dump All Container Logs
        if: failure() || cancelled()
        run: docker compose -p prost-o-projekt logs
      
      # 4. Uruchamiamy testy E2E (W DOCKERZE)
      # To jest kluczowa zmiana!
      # UÅ¼ywamy tego samego 'docker-compose.test.yml' co lokalnie.
      # Podpinamy siÄ™ pod ten sam projekt (-p prost-o-projekt), Å¼eby widzieÄ‡ sieÄ‡.
      - name: Run Playwright Tests (Docker)
        run: |
          docker compose -p prost-o-projekt -f docker-compose-test.yml run --rm e2e-tests

      # 5. Logi w razie bÅ‚Ä™du
      - name: Dump Docker Logs
        if: failure()
        run: docker compose -p prost-o-projekt logs